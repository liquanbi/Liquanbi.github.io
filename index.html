<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python脚本执行控制面板</title>
    <style>
        /* 确保所有元素边距和边框计算正确 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* 关键：body 设置最小高度为视口高度，并禁止溢出 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; /* 确保不溢出 */
            overflow: hidden; /* 关键：禁止页面滚动 */
            padding: 20px;
            font-size: 13px;
            width: 100%;
        }
        /* 关键：container 占据 body 的可用空间 */
        .container {
            display: flex;
            gap: 20px;
            width: 100%;
            height: 100%; /* 占据 body 的 100% 高度 */
        }
        
        /* ======================================= */
        /* 左侧任务列表区域                          */
        /* ======================================= */
        .task-panel {
            flex: 0 0 70%;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            /* 关键：确保 task-panel 在小屏幕上不会无限扩张，虽然 flex: 0 0 70% 已经限制，但防止内部元素溢出 */
            min-width: 0;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        /* 状态面板布局 */
        .status-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* 状态显示容器 */
        #statusContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .status-idle {
            background: #6c757d;
        }
        
        .status-running {
            background: #28a745;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 连接状态颜色 */
        .status-connected {
            background: #28a745; /* 绿色 */
        }
        .status-disconnected {
            background: #dc3545; /* 红色 */
        }
        
        /* ====== 自定义命令面板样式 ====== */
        .custom-command-panel {
            background: #e9f0ff; 
            border: 1px solid #c8d8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0; 
        }

        .custom-input-group {
            display: flex;
            gap: 10px;
        }

        #customCommandInput {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 12px;
        }

        .custom-execute-button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            background: #108e48; 
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .custom-execute-button:hover:not(:disabled) {
            background: #0a6932;
        }

        .custom-execute-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .custom-execute-button.running {
            background: #28a745;
        }
        /* ======================================= */

        .task-list {
            flex: 1; 
            overflow-y: auto; 
        }
        
        .task-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .task-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .task-button {
            flex: 0 0 100px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #007bff;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
        }
        
        .task-button:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .task-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .task-button.running {
            background: #28a745;
        }
        
        .task-button.error {
            background: #dc3545;
        }
        
        .task-info {
            flex: 1;
            /* 关键：确保此容器不会被其内容撑大，尊重父容器的 flex 布局 */
            min-width: 0; 
        }
        
        .task-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
            font-size: 13px;
        }
        
        /* ====== 核心修复 ====== */
        .task-description {
            color: #6c757d;
            font-size: 11px;
            line-height: 1.4;
            /* 强制在任何字符处换行，以防止超长的文件路径或描述溢出 */
            word-break: break-all; 
            overflow-wrap: break-word; /* 兼容性写法 */
        }
        /* ====================== */

        /* ======================================= */
        /* 右侧日志区域 (比例固定)                   */
        /* ======================================= */
        .log-panel {
            flex: 0 0 30%;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative; 
            /* 关键：防止此面板被挤压导致溢出 */
            min-width: 0;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            flex-shrink: 0; 
        }

        .log-header h3 {
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .log-actions {
            display: flex;
            gap: 8px;
        }

        .refresh-button, .clear-button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .refresh-button:hover {
            background: #138496;
        }
        
        .clear-button {
            background: #dc3545;
        }
        
        .clear-button:hover {
            background: #c82333;
        }

        /* 日志子面板容器，确保 1:1 比例 */
        .logs-container-wrapper {
            flex: 1; 
            display: flex;
            flex-direction: column;
            gap: 15px; 
            min-height: 0; 
        }

        .log-sub-panel {
            flex: 1; /* 1:1 高度比例 */
            display: flex;
            flex-direction: column;
            min-height: 0; 
        }

        .sub-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px dashed #ccc;
            flex-shrink: 0;
        }
        
        .sub-panel-title {
            color: #2c3e50;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 0; 
        }
        
        .copy-button {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .copy-button:hover {
            background: #e0a800;
        }

        .logs-container {
            flex: 1; 
            background: #1e1e1e; 
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto; 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.2;
            color: #cccccc; 
            white-space: pre-wrap; 
        }
        
        .log-entry {
            margin-bottom: 0;
            padding: 0;
            border-left: none;
            word-wrap: break-word;
            white-space: pre-wrap;
            text-align: left;
            line-height: 1.2;
            background: none;
            color: inherit; 
        }
        
        .log-success {
            color: #00ff00 !important; 
        }
        
        .log-error {
            color: #ff4444 !important; 
        }
        
        .log-running {
            color: #4da6ff !important; 
        }
        
        .log-info {
            color: #cccccc !important; 
        }
        
        #scriptOutputPanel .log-entry {
            color: #f1c40f !important; 
            font-size: 11px;
        }

        /* 滚动条样式 (不变) */
        .task-list::-webkit-scrollbar,
        .logs-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .task-list::-webkit-scrollbar-track,
        .logs-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .task-list::-webkit-scrollbar-thumb,
        .logs-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .task-list::-webkit-scrollbar-thumb:hover,
        .logs-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Toast 提示框样式 (不变) */
        .toast-message {
            visibility: hidden; 
            min-width: 150px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px 15px;
            position: absolute;
            z-index: 10;
            left: 50%; 
            top: 50px; 
            transform: translateX(-50%);
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }

        .toast-message.show {
            visibility: visible;
            opacity: 1;
            top: 20px; 
        }
        /* 移动端响应式设计 (不变) */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 14px;
                height: auto; 
                overflow-y: auto; 
            }
            
            .container {
                flex-direction: column;
                gap: 15px;
                height: auto;
            }
            
            .task-panel,
            .log-panel {
                flex: none;
                width: 100%;
                padding: 15px;
            }
            
            .logs-container-wrapper {
                height: 350px; 
                min-height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="task-panel">
            <div class="header">
                <h1>Python Script execution control panel 3.0</h1>
            </div>
            
            <div class="status-panel">
                <div id="statusContainer">
                    <span id="serverConnectionStatus">
                        <span id="connectionIndicator" class="status-indicator status-disconnected"></span>
                        <span id="connectionText" style="font-weight: 600; color: #dc3545;">服务器连接: 检查中...</span>
                    </span>
                    <span id="executionStatus">
                        <span class="status-indicator status-idle"></span>
                        <span id="statusText" style="font-weight: 600;">空闲</span>
                        <span id="currentScript"></span>
                    </span>
                </div>
            </div>
            <div class="custom-command-panel">
                <div class="custom-input-group">
                    <input type="text" id="customCommandInput" placeholder="请输入要执行的 Python 命令，例如：python D:/script.py arg1">
                    <button class="custom-execute-button" id="btnCustomExecute" onclick="executeCustomCommand()">执行自定义</button>
                </div>
            </div>
            <div class="task-list" id="taskList">
            </div>
        </div>

        <div class="log-panel">
            <div class="log-header">
                <h3>执行日志</h3>
                <div class="log-actions">
                    <button class="refresh-button" onclick="loadLogs()">刷新日志</button>
                    <button class="clear-button" onclick="clearLogs()">清除日志</button>
                </div>
            </div>
            
            <div class="logs-container-wrapper">
                <div class="log-sub-panel">
                    <div class="sub-panel-header">
                        <h4 class="sub-panel-title">实时脚本输出 (stdout/stderr)</h4>
                        <button class="copy-button" onclick="copyOutputLogs()">复制输出</button>
                    </div>
                    <div class="logs-container" id="scriptOutputPanel">
                    </div>
                </div>
                
                <div class="log-sub-panel">
                    <h4 class="sub-panel-title">执行状态日志</h4>
                    <div class="logs-container" id="executionLogsPanel">
                    </div>
                </div>
            </div>
            <div id="toastMessage" class="toast-message"></div>
        </div>
    </div>

    <script>
        // 关键修复：定义 Ngrok 绕过警告页面的请求头
        const NGROK_HEADERS = {
            'ngrok-skip-browser-warning': 'true', 
            'Content-Type': 'application/json'
        };
        
        // 服务器地址配置
        // ***重要***：请将此URL替换为您 Ngrok 隧道实际分配的公网地址
        const SERVER_URL = 'https://andre-uncleft-unbiasedly.ngrok-free.dev'; 
        
        // 脚本配置（保持不变）
        const SCRIPTS = {
            script1: {
                name: '数据同步脚本',
                description: '执行SQL Server数据库同步任务，更新业务数据表',
                command: 'python "D:/OneDrive - 任拓数据科技（上海）有限公司/Py自动化项目/开发环境/sql server DS/main_sync_final.py"',
                buttonId: 'btnScript1'
            },
            script2: {
                name: '报表生成脚本', 
                description: '生成惠氏PSO底表报表，包含销售数据分析',
                command: 'python "D:/OneDrive - 任拓数据科技（上海）有限公司/Py自动化项目/开发环境/惠氏pso底表同步.py"',
                buttonId: 'btnScript2'
            },
            script3: {
                name: 'RC飞书价格同步',
                description: 'RC-SPT飞书价格监控修数记录同步',
                command: 'python "D:/OneDrive - 任拓数据科技（上海）有限公司/Py自动化项目/生产环境/飞书api读取刷新数据库.py"',
                buttonId: 'btnScript3'
            },
            script4: {
                name: 'deepseek_AI分析',
                description: 'MySql读取数据库deepseek自动化分析',
                command: 'python "D:/OneDrive - 任拓数据科技（上海）有限公司/Py自动化项目/AI/Deepseek.py"',
                buttonId: 'btnScript4'
            }
        };
        
        let logsCleared = false;
        
        // === 显示 Toast 提示框的函数 (不变) ===
        function showToast(message) {
            const toast = document.getElementById("toastMessage");
            if (toast) {
                toast.textContent = message;
                toast.className = "toast-message show";
                
                setTimeout(function(){ 
                    toast.className = toast.className.replace("show", ""); 
                }, 3000); 
            }
        }
        // ===================================

        // 初始化任务列表 (不变)
        function initTaskList() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            Object.entries(SCRIPTS).forEach(([key, script]) => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <button class="task-button" onclick="executeScript('${key}')" id="${script.buttonId}">
                        执行脚本
                    </button>
                    <div class="task-info">
                        <div class="task-name">${script.name}</div>
                        <div class="task-description">${script.description}</div>
                    </div>
                `;
                taskList.appendChild(taskItem);
            });
        }

        // 更新状态显示 (不变)
        async function updateStatus() {
            const connIndicator = document.getElementById('connectionIndicator');
            const connText = document.getElementById('connectionText');
            
            try {
                const response = await fetch(`${SERVER_URL}/status`, { 
                    headers: NGROK_HEADERS 
                });
                
                const data = await response.json();
                
                // 1. 更新连接状态：成功连接
                if (connIndicator && connText) {
                    connIndicator.className = 'status-indicator status-connected';
                    connText.textContent = '服务器连接: 正常';
                    connText.style.color = '#28a745';
                }

                // 2. 更新执行状态
                const statusIndicator = document.querySelector('#executionStatus .status-indicator');
                const statusText = document.getElementById('statusText');
                const currentScript = document.getElementById('currentScript');
                
                const customButton = document.getElementById('btnCustomExecute');

                if (statusIndicator && statusText && currentScript) {
                    if (data.is_running) {
                        statusIndicator.className = 'status-indicator status-running';
                        statusText.textContent = '执行中';
                        currentScript.textContent = ` - 当前执行: ${data.current_script}`;
                        
                        Object.values(SCRIPTS).forEach(script => {
                            const button = document.getElementById(script.buttonId);
                            if (button) {
                                button.disabled = true;
                                if (script.name === data.current_script) {
                                    button.className = 'task-button running';
                                    button.textContent = '执行中...';
                                } else {
                                    button.className = 'task-button';
                                    button.textContent = '等待中';
                                }
                            }
                        });
                        
                        if (customButton) {
                            customButton.disabled = true;
                            if (data.current_script === "自定义命令") {
                                customButton.className = 'custom-execute-button running';
                                customButton.textContent = '执行中...';
                            } else {
                                customButton.className = 'custom-execute-button';
                                customButton.textContent = '等待中';
                            }
                        }

                    } else {
                        statusIndicator.className = 'status-indicator status-idle';
                        statusText.textContent = '空闲';
                        currentScript.textContent = '';
                        
                        Object.values(SCRIPTS).forEach(script => {
                            const button = document.getElementById(script.buttonId);
                            if (button) {
                                button.disabled = false;
                                button.className = 'task-button';
                                button.textContent = '执行脚本';
                            }
                        });

                        if (customButton) {
                            customButton.disabled = false;
                            customButton.className = 'custom-execute-button';
                            customButton.textContent = '执行自定义';
                        }
                    }
                }
            } catch (error) {
                // 1. 更新连接状态：连接失败
                if (connIndicator && connText) {
                    connIndicator.className = 'status-indicator status-disconnected';
                    connText.textContent = '服务器连接: 失败';
                    connText.style.color = '#dc3545';
                }
                
                // 2. 更新执行状态为未知
                const statusText = document.getElementById('statusText');
                const currentScript = document.getElementById('currentScript');
                if (statusText && currentScript) {
                    statusText.textContent = '未知';
                    currentScript.textContent = '';
                }

                console.error('获取状态或连接失败:', error);
            }
        }

        // 执行脚本 (不变)
        async function executeScript(scriptKey) {
            const script = SCRIPTS[scriptKey];
            if (!script) return;

            const button = document.getElementById(script.buttonId);
            button.disabled = true;
            button.className = 'task-button running';
            button.textContent = '执行中...';

            try {
                const response = await fetch(`${SERVER_URL}/execute`, {
                    method: 'POST',
                    headers: NGROK_HEADERS, 
                    body: JSON.stringify({
                        script_command: script.command,
                        script_name: script.name
                    })
                });

                const result = await response.json();
                
                if (response.status === 423) {
                    alert(result.message);
                    button.disabled = false;
                    button.className = 'task-button';
                    button.textContent = '执行脚本';
                } else if (result.status === 'started') {
                    addLogEntry('running', `${script.name} 开始执行`, null, false); 
                    document.getElementById('scriptOutputPanel').innerHTML = '';
                    addLogEntry('info', `--- ${script.name} 脚本开始输出 ---`, null, true); 
                    startStatusPolling();
                } else {
                    addLogEntry('error', `执行失败: ${result.message}`, null, false);
                    button.disabled = false;
                    button.className = 'task-button';
                    button.textContent = '执行脚本';
                }
            } catch (error) {
                addLogEntry('error', `请求失败: ${error.message}`, null, false);
                button.disabled = false;
                button.className = 'task-button';
                button.textContent = '执行脚本';
            }
        }
        
        // 执行自定义命令函数 (不变)
        async function executeCustomCommand() {
            const inputElement = document.getElementById('customCommandInput');
            const customCommand = inputElement ? inputElement.value.trim() : '';

            if (!customCommand) {
                showToast('❌ 请先输入要执行的命令！');
                return;
            }

            const scriptName = "自定义命令";
            const buttonId = 'btnCustomExecute';
            
            const button = document.getElementById(buttonId);
            if (!button) return;

            button.disabled = true;
            button.className = 'custom-execute-button running';
            button.textContent = '执行中...';

            try {
                const response = await fetch(`${SERVER_URL}/execute`, {
                    method: 'POST',
                    headers: NGROK_HEADERS, 
                    body: JSON.stringify({
                        script_command: customCommand,
                        script_name: scriptName 
                    })
                });

                const result = await response.json();
                
                if (response.status === 423) {
                    alert(result.message);
                    button.disabled = false;
                    button.className = 'custom-execute-button';
                    button.textContent = '执行自定义';
                } else if (result.status === 'started') {
                    addLogEntry('running', `${scriptName} 开始执行`, null, false); 
                    document.getElementById('scriptOutputPanel').innerHTML = '';
                    addLogEntry('info', `--- ${scriptName} 脚本开始输出 ---`, null, true); 
                    startStatusPolling();
                    inputElement.value = '';
                } else {
                    addLogEntry('error', `执行失败: ${result.message}`, null, false);
                    button.disabled = false;
                    button.className = 'custom-execute-button';
                    button.textContent = '执行自定义';
                }
            } catch (error) {
                addLogEntry('error', `请求失败: ${error.message}`, null, false);
                button.disabled = false;
                button.className = 'custom-execute-button';
                button.textContent = '执行自定义';
            }
        }

        // 清除日志 (不变)
        async function clearLogs() {
            const scriptOutputPanel = document.getElementById('scriptOutputPanel');
            const executionLogsPanel = document.getElementById('executionLogsPanel');

            try {
                const response = await fetch(`${SERVER_URL}/clear_logs`, {
                    method: 'POST',
                    headers: NGROK_HEADERS,
                });
                
                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    if (scriptOutputPanel && executionLogsPanel) {
                        scriptOutputPanel.innerHTML = '';
                        executionLogsPanel.innerHTML = '';
                    }
                    
                    addLogEntry('info', '✅ 后端执行日志已清除', null, false); 
                    addLogEntry('info', '脚本输出区域已清空', null, true); 
                    
                    showToast('✅ 所有历史日志已清除！');

                    logsCleared = true;
                    setTimeout(() => {
                        logsCleared = false;
                        loadLogs(); 
                    }, 1000); 

                } else {
                    showToast(`❌ 清除失败: ${result.message || '未知错误'}`);
                    addLogEntry('error', `后端日志清除请求失败: ${result.message || '未知错误'}`, null, false);
                }

            } catch (error) {
                console.error('调用清除日志 API 失败:', error);
                showToast('❌ 服务器连接失败，无法清除日志！');
                addLogEntry('error', `网络请求失败，无法清除后端日志: ${error.message}`, null, false);
            }
        }

        // 加载日志 (不变)
        async function loadLogs() {
            if (logsCleared) {
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/logs`, { 
                    headers: NGROK_HEADERS 
                });
                const data = await response.json();
                
                const scriptOutputPanel = document.getElementById('scriptOutputPanel');
                const executionLogsPanel = document.getElementById('executionLogsPanel');
                
                scriptOutputPanel.innerHTML = '';
                executionLogsPanel.innerHTML = '';
                
                let outputLogFound = false;
                let statusLogFound = false;

                if (data.logs && data.logs.length > 0) {
                    
                    data.logs.forEach(log => {
                        const isScriptOutput = log.message.includes(' 输出: ');
                        
                        if (isScriptOutput) {
                            addLogEntry(log.status, log.message, log.timestamp, true);
                            outputLogFound = true;
                        } else {
                            addLogEntry(log.status, log.message, log.timestamp, false);
                            statusLogFound = true;
                        }
                    });
                }

                if (!outputLogFound) {
                    addLogEntry('info', '暂无脚本输出', new Date().toLocaleString(), true);
                }
                if (!statusLogFound) {
                    addLogEntry('info', '系统就绪，等待执行命令...', new Date().toLocaleString(), false);
                }

                scriptOutputPanel.scrollTop = scriptOutputPanel.scrollHeight;
                executionLogsPanel.scrollTop = executionLogsPanel.scrollHeight;

            } catch (error) {
                addLogEntry('error', `加载日志失败: ${error.message}`, null, false);
            }
        }

        // 添加日志条目 (不变)
        function addLogEntry(status, message, timestamp = null, isOutputPanel = false) {
            const targetPanel = isOutputPanel 
                                ? document.getElementById('scriptOutputPanel') 
                                : document.getElementById('executionLogsPanel');
            
            if (!targetPanel) return;

            const logEntry = document.createElement('div');
            let displayMessage = message;
            
            logEntry.className = `log-entry log-${status}`;

            if (isOutputPanel) {
                const outputIndex = message.indexOf(' 输出: ');
                if (outputIndex !== -1) {
                    displayMessage = message.substring(outputIndex + 4); 
                }
                
                logEntry.textContent = displayMessage;
            } 
            else {
                const statusPrefix = {
                    'running': 'START',
                    'success': 'DONE',
                    'error': 'FAIL',
                    'info': 'INFO'
                }[status] || status.toUpperCase();

                const now = (timestamp ? new Date(timestamp) : new Date()).toLocaleTimeString('zh-CN', { hour12: false });
                
                const styledMessage = `<span style="color:#666; margin-right: 8px;">[${now}]</span><span style="font-weight: bold; margin-right: 5px;">[${statusPrefix}]</span>${displayMessage}`;
                
                logEntry.innerHTML = styledMessage;
            }
            
            targetPanel.appendChild(logEntry);
            targetPanel.scrollTop = targetPanel.scrollHeight;
        }

        // 复制脚本输出日志的函数 (不变)
        async function copyOutputLogs() {
            const scriptOutputPanel = document.getElementById('scriptOutputPanel');
            const logContent = scriptOutputPanel.innerText;

            if (!logContent.trim()) {
                showToast('输出框内容为空！');
                return;
            }

            try {
                await navigator.clipboard.writeText(logContent);
                showToast('✅ 脚本输出已复制！');
            } catch (err) {
                console.error('复制失败: ', err);
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = logContent;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                showToast('✅ 复制成功 (兼容模式)');
            }
        }
        
        // 状态轮询 (不变)
        let statusPollInterval;
        function startStatusPolling() {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
            }
            
            statusPollInterval = setInterval(async () => {
                await updateStatus();
                
                const isRunning = document.getElementById('statusText').textContent.includes('执行中');
                
                if (isRunning) {
                    await loadLogs(); 
                } else {
                    clearInterval(statusPollInterval);
                    await loadLogs(); 
                }
            }, 1000); 
        }

        // 初始化 (不变)
        document.addEventListener('DOMContentLoaded', function() {
            initTaskList();
            updateStatus();
            loadLogs();
            setInterval(updateStatus, 5000); 
        });
    </script>
</body>
</html>
