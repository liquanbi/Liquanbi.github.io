<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BI Âà∑Êñ∞ÊéßÂà∂Âè∞</title> 
    <style>
        /* Ê†∑Âºè‰ª£Á†Å‰∏çÂèò */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #ffffff; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden; 
            padding: 10px; 
            font-size: 14px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header-panel {
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            flex-shrink: 0;
            padding: 2px 0; 
            height: auto;
        }

        .refresh-script-button {
            padding: 6px 15px; 
            border: none;
            border-radius: 6px;
            background: #007bff; 
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .refresh-script-button:hover:not(:disabled) {
            background: #0056b3;
        }

        .refresh-script-button:disabled {
            background: #adb5bd; 
            cursor: not-allowed;
            opacity: 1; 
        }
        
        .refresh-script-button.running {
            background: #ff9800; 
        }

        .refresh-script-button.cooldown {
            background: #dc3545; 
        }
        
        .status-text-container {
            margin-right: 15px;
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 25px; 
        }

        .powerbi-container {
            flex: 1; 
            min-height: 0; 
            overflow: hidden; 
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1); 
        }

        .powerbi-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .toast-message {
            visibility: hidden; 
            min-width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: fixed; 
            z-index: 100;
            left: 50%; 
            top: 15px; 
            transform: translateX(-50%);
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }
        .toast-message.show {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .header-panel {
                justify-content: space-between;
                padding: 5px 0;
            }
            .refresh-script-button {
                min-width: unset;
                padding: 6px 10px;
                font-size: 12px;
            }
            .status-text-container {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header-panel">
        <div class="status-text-container">
            <span id="cooldownRemaining"></span>
        </div>

        <button class="refresh-script-button" id="btnRefreshScript" onclick="executeRefreshScript()" disabled>
            <span id="refreshIcon">‚ùå</span>
            <span id="refreshButtonText">ËøûÊé•‰∏≠...</span>
        </button>
    </div>

    <div class="powerbi-container">
        <iframe 
            title="YLshopdata_Check" 
            width="100%" 
            height="100%" 
            src="https://app.powerbi.com/view?r=eyJrIjoiZTRjMjAzZmEtNTFiZi00ZGNlLWI2OTUtODM3M2M4MmUzOThiIiwidCI6IjE3MDA3Yzk5LWUzMzMtNGZlMS1iZWNmLThkYTRjMDI0NWQ2YiIsImMiOjEwfQ%3D%3D" 
            frameborder="0" 
            allowFullScreen="true">
        </iframe>
    </div>
    
    <div id="toastMessage" class="toast-message"></div>

    <script>
        // ÂÖ≥ÈîÆÈÖçÁΩÆ
        const NGROK_HEADERS = {
            'ngrok-skip-browser-warning': 'true', 
            'Content-Type': 'application/json'
        };
        
        // üö® Ê∑∑Ê∑ÜÁÇπÔºöÂ∞ÜÊòéÊñá URL ÊõøÊç¢‰∏∫ Base64 ÁºñÁ†Å
        // Á§∫‰æãÔºöÂ¶ÇÊûúÊòéÊñáÊòØ 'https://your-ngrok-address.ngrok-free.dev'
        // ÁºñÁ†ÅÂêéÂèØËÉΩÊòØ 'aHR0cHM6Ly95b3VyLW5ncm9rLWFkZHJlc3Mubmdyb2stZnJlZS5kZXY='
        // ***ÈáçË¶Å***ÔºöËØ∑Â∞Ü‰ª•‰∏ãÂ≠óÁ¨¶‰∏≤ÊõøÊç¢‰∏∫ÊÇ®Ëá™Â∑±ÁöÑ Ngrok Âú∞ÂùÄÁöÑ Base64 ÁºñÁ†Å
        const ENCODED_SERVER_URL = 'aHR0cHM6Ly9hbmRyZS11bmNsZWZ0LXVuYmlhc2VkbHkubmdyb2stZnJlZS5kZXY='; 
        
        // **Âà∑Êñ∞ËÑöÊú¨ÈÖçÁΩÆ**
        const REFRESH_SCRIPT = {
            name: 'PowerBIÂà∑Êñ∞ËÑöÊú¨',
            command: 'python "D:/Py Project/pbi_refresh_script/refresh_script.py"', 
            buttonId: 'btnRefreshScript'
        };

        const COOLDOWN_MINUTES = 5;
        const COOLDOWN_MILLISECONDS = COOLDOWN_MINUTES * 60 * 1000;
        
        // Áä∂ÊÄÅÂ≠òÂÇ®
        let lastSuccessfulRefreshTime = localStorage.getItem('lastRefreshTime') ? 
            new Date(localStorage.getItem('lastRefreshTime')) : null;
        let wasRunning = false; 

        // === Ê†∏ÂøÉÂäüËÉΩÂáΩÊï∞ ===

        /**
         * üåü Êñ∞Â¢ûÔºöËß£Á†ÅÂáΩÊï∞
         */
        function getDecodedServerUrl() {
            try {
                return atob(ENCODED_SERVER_URL);
            } catch (e) {
                console.error("URL Ëß£Á†ÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü• Base64 Â≠óÁ¨¶‰∏≤ÊòØÂê¶Ê≠£Á°Æ„ÄÇ");
                return null;
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toastMessage");
            if (toast) {
                toast.textContent = message;
                toast.className = "toast-message show";
                setTimeout(function(){ 
                    toast.className = toast.className.replace("show", ""); 
                }, 3000); 
            }
        }

        function checkCooldown(button) {
            const statusText = document.getElementById('statusText');
            const cooldownRemaining = document.getElementById('cooldownRemaining');
            // ... (ÂÜ∑Âç¥ÈÄªËæë‰∏çÂèò) ...
            if (!lastSuccessfulRefreshTime) {
                cooldownRemaining.textContent = '';
                return false; 
            }
            
            const now = new Date();
            const elapsedMilliseconds = now - lastSuccessfulRefreshTime;
            const remainingMilliseconds = COOLDOWN_MILLISECONDS - elapsedMilliseconds;

            if (remainingMilliseconds > 0) {
                const remainingSeconds = Math.ceil(remainingMilliseconds / 1000);
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                
                button.disabled = true;
                button.className = 'refresh-script-button cooldown';
                document.getElementById('refreshButtonText').textContent = 'wait5min';
                document.getElementById('refreshIcon').textContent = 'üîí';
                
                statusText.textContent = 'wait5min';
                cooldownRemaining.textContent = `(${minutes}m ${seconds}s)`;
                return true;
            } else {
                cooldownRemaining.textContent = '';
                return false;
            }
        }
        
        async function updateStatus() {
            const statusText = document.getElementById('statusText');
            const refreshButton = document.getElementById(REFRESH_SCRIPT.buttonId);
            const SERVER_URL = getDecodedServerUrl(); // üåü ‰ΩøÁî®Ëß£Á†ÅÂêéÁöÑ URL

            let isConnected = false;
            let data = { is_running: false };
            
            if (!SERVER_URL) return; // Â¶ÇÊûúËß£Á†ÅÂ§±Ë¥•ÔºåÁõ¥Êé•ÈÄÄÂá∫

            try {
                const response = await fetch(`${SERVER_URL}/status`, { 
                    headers: NGROK_HEADERS 
                });
                data = await response.json();
                isConnected = true;
            } catch (error) {
                isConnected = false;
            }

            // 1. Â§ÑÁêÜËøûÊé•Â§±Ë¥•
            if (!isConnected) {
                statusText.textContent = 'ËøûÊé•Â§±Ë¥•';
                document.getElementById('cooldownRemaining').textContent = '';
                refreshButton.disabled = true;
                refreshButton.className = 'refresh-script-button'; 
                document.getElementById('refreshButtonText').textContent = 'ËøûÊé•Â§±Ë¥•';
                document.getElementById('refreshIcon').textContent = '‚ùå';
                return; 
            }

            // 2. ËøûÊé•ÊàêÂäüÔºåÊ£ÄÊü•ÊâßË°å/ÂÜ∑Âç¥Áä∂ÊÄÅ
            if (data.is_running) {
                // ... (ÊâßË°å‰∏≠Áä∂ÊÄÅÈÄªËæë‰∏çÂèò) ...
                wasRunning = true; 
                statusText.textContent = 'ÊâßË°å‰∏≠';
                document.getElementById('cooldownRemaining').textContent = '';
                
                refreshButton.disabled = true;
                refreshButton.className = 'refresh-script-button running';
                document.getElementById('refreshButtonText').textContent = 'ÊâßË°å‰∏≠...';
                document.getElementById('refreshIcon').textContent = '...';

            } else {
                const justFinished = wasRunning;
                wasRunning = false;
                
                if (justFinished) {
                    lastSuccessfulRefreshTime = new Date();
                    localStorage.setItem('lastRefreshTime', lastSuccessfulRefreshTime.toISOString());
                    localStorage.setItem('lastExecutionStatus', 'success'); 
                }

                const inCooldown = checkCooldown(refreshButton);
                
                if (!inCooldown) {
                    refreshButton.disabled = false;
                    refreshButton.className = 'refresh-script-button';
                    document.getElementById('refreshButtonText').textContent = 'Refresh'; 
                    document.getElementById('refreshIcon').textContent = 'üîÑ';

                    if (localStorage.getItem('lastExecutionStatus') === 'success') {
                        statusText.textContent = 'Â∑≤ÂÆåÊàêÂà∑Êñ∞';
                        document.getElementById('cooldownRemaining').textContent = `(‰∏äÊ¨°: ${lastSuccessfulRefreshTime ? lastSuccessfulRefreshTime.toLocaleTimeString('zh-CN') : ''})`;
                    } else {
                        statusText.textContent = ''; 
                        document.getElementById('cooldownRemaining').textContent = '';
                    }
                }
            }
        }

        async function executeRefreshScript() {
            const script = REFRESH_SCRIPT;
            const button = document.getElementById(script.buttonId);
            const SERVER_URL = getDecodedServerUrl(); // üåü ‰ΩøÁî®Ëß£Á†ÅÂêéÁöÑ URL

            if (checkCooldown(button) || !SERVER_URL) {
                if (!SERVER_URL) showToast("URLÈÖçÁΩÆÈîôËØØÔºåÊó†Ê≥ïÊâßË°å„ÄÇ");
                return;
            }

            button.disabled = true;
            button.className = 'refresh-script-button running';
            document.getElementById('refreshButtonText').textContent = 'ÂèëÈÄÅÊåá‰ª§...';
            document.getElementById('refreshIcon').textContent = '...';

            try {
                const response = await fetch(`${SERVER_URL}/execute`, {
                    method: 'POST',
                    headers: NGROK_HEADERS, 
                    body: JSON.stringify({
                        script_command: script.command,
                        script_name: script.name
                    })
                });

                const result = await response.json();
                
                if (response.status === 423) {
                    showToast(`‚ùå ËÑöÊú¨ÊâßË°åÂ§±Ë¥•: ${result.message}`);
                    updateStatus(); 
                } else if (result.status === 'started') {
                    localStorage.setItem('lastExecutionStatus', 'running');
                    showToast(`‚úÖ Âà∑Êñ∞ËÑöÊú¨Êåá‰ª§Â∑≤ÂèëÈÄÅÔºÅ`);
                    startStatusPolling(); 
                } else {
                    showToast(`‚ùå ÊâßË°åÂ§±Ë¥•: ${result.message || 'Êú™Áü•ÈîôËØØ'}`);
                    updateStatus();
                }
            } catch (error) {
                showToast(`‚ùå ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Âô®ËøûÊé•„ÄÇ`);
                updateStatus();
            }
        }

        // === ËΩÆËØ¢ÊéßÂà∂‰∏çÂèò ===
        let statusPollInterval;
        
        function startStatusPolling() {
            if (statusPollInterval) clearInterval(statusPollInterval);
            wasRunning = false; 

            statusPollInterval = setInterval(async () => {
                const previousIsRunning = wasRunning;
                
                await updateStatus(); 
                
                const currentIsRunning = document.getElementById('statusText').textContent.includes('ÊâßË°å‰∏≠');
                wasRunning = currentIsRunning; 

                if (previousIsRunning && !currentIsRunning) {
                    clearInterval(statusPollInterval);
                    await updateStatus(); 
                    showToast('‚úÖ Power BI Âà∑Êñ∞Â∑≤ÂÆåÊàêÔºÅÂ∑≤ÂêØÁî® 5 ÂàÜÈíüÂÜ∑Âç¥„ÄÇ');
                }
                
                if (!currentIsRunning && !document.getElementById('statusText').textContent.includes('wait5min')) {
                     clearInterval(statusPollInterval);
                }
            }, 1000); 
        }

        function startGeneralPolling() {
            setInterval(updateStatus, 5000); 
            
            setInterval(() => {
                const refreshButton = document.getElementById(REFRESH_SCRIPT.buttonId);
                if (!document.getElementById('statusText').textContent.includes('ÊâßË°å‰∏≠')) {
                    checkCooldown(refreshButton);
                }
            }, 1000); 
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            startGeneralPolling();
        });
    </script>
</body>
</html>
